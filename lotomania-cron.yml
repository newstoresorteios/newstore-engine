name: lotomania-cron

on:
  schedule:
    # 20:00 BRT = 23:00 UTC (seg/qua/sex)
   # - cron: "0 23 * * 1,3,5"
 # workflow_dispatch:
    inputs:
      skip_wait:
        description: "Pular a espera e rodar o resultado imediatamente? (true/false)"
        required: false
        default: "false"

#jobs:
  run-both-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    concurrency:
      group: lotomania-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 1) 20:00 BRT -> aviso com link YouTube
      - name: Notify start (20:00 BRT)
        env:
          # ---- VARIÁVEIS COM VALORES PREENCHIDOS ----
          POSTGRES_URL: "postgres://postgres.mgwvavsjxzwflibcjzhd:CtPrJ5nOpomcjuJV@aws-1-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require&supa=base-pooler.x"
          SMTP_HOST: "smtp-relay.brevo.com"
          SMTP_PORT: "587"
          SMTP_USER: "9712be001@smtp-brevo.com"
          SMTP_PASS: "aVAwYKIWRD8hx47p"

          # ---- VARIÁVEIS NÃO SECRETAS ----
          COMMIT: "true"                         # "false" para dry-run
          SMTP_NAME: "NewStore Sorteios"
          APP_NAME: "NewStore Sorteios"
          ADMIN_EMAIL: "newrecreio@gmail.com"
          LOTOMANIA_ENDPOINT: "https://servicebus2.caixa.gov.br/portaldeloterias/api/lotomania"

          # Link do YouTube
          YOUTUBE_STREAMS_URL: "https://www.youtube.com/@canalcaixa/streams"
          # Fallback opcional
          NOTIFY_FALLBACK_TO: "newrecreio@gmail.com"
        run: python notify_start.py

      # 2) Espera até 21:15 BRT (00:15 UTC do dia seguinte) no MESMO run
      - name: Wait until 21:15 BRT (~75min)
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_wait != 'true' }}
        shell: bash
        run: |
          echo "Calculando segundos até 00:15 UTC (21:15 BRT) do mesmo ciclo..."
          NOW=$(date -u +%s)
          TARGET=$(date -u -d 'tomorrow 00:15:00' +%s)
          SECS=$(( TARGET - NOW ))
          if [ $SECS -lt 0 ]; then SECS=0; fi
          echo "Aguardando ${SECS}s (~$((SECS/60)) min) até 21:15 BRT..."
          sleep "${SECS}s"

      # 3) 21:15 BRT -> resultado (fluxo atual do main.py)
      - name: Run main.py (resultado 21:15 BRT)
        env:
          # ---- VARIÁVEIS COM VALORES PREENCHIDOS ----
          POSTGRES_URL: "postgres://postgres.mgwvavsjxzwflibcjzhd:CtPrJ5nOpomcjuJV@aws-1-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require&supa=base-pooler.x"
          SMTP_HOST: "smtp-relay.brevo.com"
          SMTP_PORT: "587"
          SMTP_USER: "9712be001@smtp-brevo.com"
          SMTP_PASS: "aVAwYKIWRD8hx47p"

          # ---- VARIÁVEIS NÃO SECRETAS ----
          COMMIT: "true"                         # "false" para dry-run
          SMTP_NAME: "NewStore Sorteios"
          APP_NAME: "NewStore Sorteios"
          ADMIN_EMAIL: "newrecreio@gmail.com"
          LOTOMANIA_ENDPOINT: "https://servicebus2.caixa.gov.br/portaldeloterias/api/lotomania"
        run: python main.py
